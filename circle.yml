machine:
  environment:
    MIX_ENV: test
dependencies:
  cache_directories:
    - ../elixir
    - ../erlang-solutions
    - /home/ubuntu/.mix
    - _build
    - deps
  pre:
    - if [[ ! -e ../erlang-solutions ]]; then cd .. && wget http://packages.erlang-solutions.com/erlang-solutions_1.0_all.deb && mkdir erlang-solutions && mv erlang-solutions_1.0_all.deb erlang-solutions && cd -; fi
    - sudo dpkg -i /home/ubuntu/erlang-solutions/erlang-solutions_1.0_all.deb
    - sudo apt-get update
    - sudo apt-get remove -y erlang-syntax-tools
    - sudo apt-get install -y esl-erlang=1:18.3
    - sudo apt-get install -y elixir=1.3.0-1
    - mix local.hex --force && mix local.rebar --force
  post:
    - mix deps.get --only test
    - mix compile
    # generate plts so they are stored in cache of /home/ubuntu/.mix and _build
    - mix dialyze --no-analyse
test:
  override:
    - mix test --cover
  post:
    - mix credo --strict
    - mix dialyze
    - mix docs 2>&1 | tee mix-docs.txt
    - if grep "Closing unclosed backquotes" mix-docs.txt; then exit 1; fi
    - mix inch.report
    - cp -a cover ${CIRCLE_ARTIFACTS}/
    - mkdir -p ${CIRCLE_TEST_REPORTS}/Elixir
    - mv _build/test/lib/alembic/test-junit-report.xml ${CIRCLE_TEST_REPORTS}/Elixir/
